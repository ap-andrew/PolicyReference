<p>[toc]</p>
<p>The Apigee cache sits between one or more servers (origin servers) and one or more clients, and watches requests, saving copies of the responses. If there is another request for the same URL, the cache can use the copied response instead of asking the originating server for that information.</p>
<p>There are two main reasons for using a cache:</p>
<ul>
	<li><strong>To reduce latency:</strong> The request is satisfied from the cache (which is closer to the client) instead of the origin server, so the cache gets the representation and displays it in a shorter time. This makes the server more responsive.</li>
	<li><strong>To reduce network traffic:</strong> Representations are reused, so the impact of processing duplicate or redundant requests is reduced. Cache reduces the amount of bandwidth you use, which decreases bandwidth requirements for the system.</li>
</ul>
<h2><a class="jumplink" name="define_resource"></a>Defining a Cache resource</h2>
<p>To use the caching policies, you need to set up a Cache resource. You can create multiple Cache resources in each environment. The scope of a Cache is limited to an account. When the Cache is created, a Cache can be populated with any serializable data.</p>
<p><strong>Note:</strong> A default Cache resource is configured for your organization when an Apigee organization is created. Under ordinary circumstances, you do not need to explicitly configure a Cache to use the ResponseCaching policy. Only configure a cache when you need to customize the cache settings and configuration optimize performance. If you have questions about your Cache resource configuration, contact <a href="mailto:support@apigee.com">Apigee Support</a>.</p>

<p>See also: <strong>ResponseCaching policy:</strong> See [node:26].</p>

<h2>Manage Caches using the API Platform API</h2>

<h3>Create a Cache</h3>

<p>Use the API Platform API to create a Cache resource. Caches are created per environment. A Cache created in 'test', for example, cannot be access by API proxies deployed in 'prod'. 
For example:</p>

<pre>$ curl -H "content-type:text/xml" -X POST -d \
'&lt;Cache name=&quot;test-cache&quot;&gt;
	&lt;Description&gt;A Cache resource for the test environment.&lt;/Description&gt;
	&lt;MaxElementsInMemory&gt;100&lt;/MaxElementsInMemory&gt;
	&lt;MaxElementsOnDisk&gt;1000&lt;/MaxElementsOnDisk&gt;
	&lt;OverflowToDisk&gt;true&lt;/OverflowToDisk&gt;
	&lt;Persistent&gt;false&lt;/Persistent&gt;
	&lt;ExpirySettings&gt;
	  &lt;TimeoutInSec&gt;300&lt;/TimeoutInSec&gt;
	&lt;/ExpirySettings&gt;&lt;Compression&gt;
	&lt;MinimumSizeInKB&gt;1024&lt;/MinimumSizeInKB&gt;
	&lt;/Compression&gt;
&lt;/Cache&gt;' \
https://api.enterprise.apigee.com/v1/o/{org_name}/environments/test/caches \
-u myname:mypass</pre>

<h3>Update a Cache</h3>

<p>To modify the Cache resource created above, issue a complete payload POST request to the same URI as above,  except include the name of the Cache resource as a URI parameter </p>

<pre>$ curl -H "content-type:text/xml" -X POST -d \
'&lt;Cache name=&quot;test-cache&quot;&gt;
	&lt;Description&gt;Updating the Cache.&lt;/Description&gt;
	&lt;MaxElementsInMemory&gt;100&lt;/MaxElementsInMemory&gt;
	&lt;MaxElementsOnDisk&gt;1000&lt;/MaxElementsOnDisk&gt;
	&lt;OverflowToDisk&gt;true&lt;/OverflowToDisk&gt;
	&lt;Persistent&gt;false&lt;/Persistent&gt;
	&lt;ExpirySettings&gt;
	  &lt;TimeoutInSec&gt;300&lt;/TimeoutInSec&gt;
	&lt;/ExpirySettings&gt;&lt;Compression&gt;
	&lt;MinimumSizeInKB&gt;1024&lt;/MinimumSizeInKB&gt;
	&lt;/Compression&gt;
&lt;/Cache&gt;' \
https://api.enterprise.apigee.com/v1/o/{org_name}/environments/test/caches/{cache_name} \
-u myname:mypass</pre>

<h3>Delete a Cache</h3>
<p>To delete the Cache resource created above, use the DELETE verb:</p>

<pre>$ curl -X DELETE \ 
https://api.enterprise.apigee.com/v1/o/{org_name}/environments/test/caches/{cache_name}/entries \
-u myname:mypass</pre>

<h3>View Cache contents</h3>
<pre>$ curl https://api.enterprise.apigee.com/v1/o/{org_name}/environments/test/caches/{cache_name} \
-u myname:mypass</pre>

<h3>Delete a Cache entry</h3>
<pre>$ curl -X DELETE \ 
https://api.enterprise.apigee.com/v1/o/{org_name}/environments/test/caches/{cache_name}/entries/{cache_entry_key} \
-u myname:mypass</pre>

<h3>Flush the Cache</h3>
<pre>$ curl https://api.enterprise.apigee.com/v1/o/{org_name}/environments/test/caches/{cache_name}?action=clear&prefix={cache_key_prefix} \
-u myname:mypass</pre>

<h2>Access the Cache at runtime: PopulateCache</h2>

For example, the following PopulateCache policy writes the value of the variable <code>twitter-translate.apiAccessToken</code> to the Cache resource named <code>test-cache</code>.

<pre>&lt;PopulateCache enabled=&quot;true&quot; continueOnError=&quot;false&quot; async=&quot;false&quot; name=&quot;token-cache&quot;&gt;
    &lt;CacheResource&gt;test-cache&lt;/CacheResource&gt;
    &lt;Source&gt;twitter-translate.apiAccessToken&lt;/Source&gt;
    &lt;Scope&gt;Exclusive&lt;/Scope&gt;
    &lt;CacheKey&gt;
        &lt;KeyFragment&gt;apiAccessToken&lt;/KeyFragment&gt;
    &lt;/CacheKey&gt;
    &lt;ExpirySettings&gt;
        &lt;TimeoutInSec&gt;600&lt;/TimeoutInSec&gt;
    &lt;/ExpirySettings&gt;
&lt;/PopulateCache&gt;</pre>

<h2>Access the Cache at runtime: LookupCache</h2>

<p>For example, the following LookupCache policy reads from the Cache resource named <code>test-cache</code> and writes the value to the variable <code>twitter-translate.apiAccessToken</code>.</p>

<pre>&lt;LookupCache enabled=&quot;true&quot; continueOnError=&quot;false&quot; async=&quot;false&quot; name=&quot;token-cache&quot;&gt;
    &lt;CacheResource&gt;test-cache&lt;/CacheResource&gt;
    &lt;AssignTo&gt;twitter-translate.apiAccessToken&lt;/AssignTo&gt;
    &lt;Scope&gt;Exclusive&lt;/Scope&gt;
    &lt;CacheKey&gt;
        &lt;KeyFragment&gt;apiAccessToken&lt;/KeyFragment&gt;
    &lt;/CacheKey&gt;
&lt;/LookupCache&gt;</pre>

<h2>Access the Cache at runtime: InvalidateCache</h2>

<p>The Cache resource can be invalidated explicitly by specifying an HTTP header. When a request that contains the specified HTTP header is received, the Cache is flushed.</p>

<pre>&lt;InvalidateCache name=&quot;InvalidateMyCache&quot;&gt;
    &lt;CacheResource&gt;test-cache&lt;/CacheResource&gt;
    &lt;Scope&gt;Exclusive&lt;/Scope&gt;
    &lt;CacheKey&gt;
         &lt;Prefix&gt;apiAccessToken&lt;/Prefix&gt;
        &lt;KeyFragment ref=&quot;request.header.invalidate_cache&quot; /&gt;
    &lt;/CacheKey&gt;
    &lt;PurgeChildEntries&gt;true&lt;/PurgeChildEntries&gt;
&lt;/InvalidateCache&gt;</pre>

<h2>Configuring a Cache resource</h2>
<p>You can configure a Cache resource using the following elements.</p>
<table border="0" cellpadding="1" cellspacing="1" class="table" style="width: 690px;">
	<thead>
		<tr>
			<th colspan="2" style="text-align: left;">Field Name</th>
			<th style="text-align: left;">Description</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td colspan="2">Description</td>
			<td>Description of the resource.</td>
		</tr>
		<tr>
			<td colspan="2">MaxElementsInMemory</td>
			<td>Maximum number of cache entries allowed in memory. Upon reaching the maximum limit, entries are discarded using Least Recently Used (LRU) algorithm.</td>
		</tr>
		<tr>
			<td colspan="2">MaxElementsOnDisk</td>
			<td>Maximum number of cache entries allowed in the disk. Upon reaching the maximum limit, entries are discarded using LRU algorithm.</td>
		</tr>
		<tr>
			<td colspan="2">OverflowToDisk</td>
			<td>Valid values: true/false<br>
				Default value: false<br>
				If true, the elements discarded from in-memory cache are stored to a disk cache. The elements discarded from disk cache are permanently deleted.</td>
		</tr>
		<tr>
			<td colspan="2">Persistent</td>
			<td>Valid values: true/false<br>
				Default value: false<br>
				If true, cache entries are persistent across restarts. Persistence of cache ensures that all cached messages are readily available during the crash-recovery process and therefore, prevents data loss.</td>
		</tr>
		<tr>
			<td colspan="1" rowspan="3">ExpirySettings</td>
			<td>TimeoutInSec</td>
			<td>Duration (in seconds, ss) to leave for the cached entry.</td>
		</tr>
		<tr>
			<td>TimeOfDay</td>
			<td>A specific time (hh:mm:ss) of day.</td>
		</tr>
		<tr>
			<td>ExpiryDate</td>
			<td>Specify the date (mm-dd-yyyy).</td>
		</tr>
		<tr>
			<td>Compression</td>
			<td>MinimumSizeInKB</td>
			<td>Optional. If specified, all entries above this size are compressed when stored to disk.</td>
		</tr>
	</tbody>
</table>
<h3>Example - Cache resource configuration</h3>
<p>[gist:2627206]</p>


<h2><a class="jumplink" name="populate"></a>Configuring the PopulateCache policy</h2>

<p>Configure the PopulateCache policy using the following elements.</p>
<table border="0" cellpadding="1" cellspacing="1" class="table" style="width: 690px;">
	<thead>
		<tr>
			<th colspan="2" style="text-align: left;">Field Name</th>
			<th style="text-align: left;">Description</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td colspan="2">CacheResource</td>
			<td>Specifies the cache resource to be used.</td>
		</tr>
		<tr>
			<td colspan="2">Source</td>
			<td>Writes specified information from the source to the cache.</td>
		</tr>
		<tr>
			<td colspan="2">Scope</td>
			<td>
				<div>Used to construct the prefix, when Prefix in CacheKey is not provided. If Prefix is provided, then Scope is ignored.</div>
				<div>Allowed values are Global, Application, Proxy, Target, and Exclusive.</div>
			</td>
		</tr>
		<tr>
			<td colspan="1" rowspan="2">CacheKey</td>
			<td>Prefix</td>
			<td>
				<div>Used for matching future requests to the cached response.</div>
				<div>If provided, it is used as the prefix for all the entries put into the cache by the policy.</div>
			</td>
		</tr>
		<tr>
			<td>KeyFragment</td>
			<td>
				<div>A cache key fragment can either contain a key or a value.</div>
				<div>All the fragments together (plus the prefix) are concatenated to create the cache key. For example, if a request message has headers id1=1 &amp; id2=1 then the resultant cache key is <em>Apigee__1__2</em>.</div>
			</td>
		</tr>
		<tr>
			<td colspan="1" rowspan="3">ExpirySettings</td>
			<td>TimeoutInSeconds</td>
			<td>Duration (in seconds, ss) to leave for the cached entry.</td>
		</tr>
		<tr>
			<td>TimeOfDay</td>
			<td>A specific time (hh:mm:ss) of day.</td>
		</tr>
		<tr>
			<td>ExpiryDate</td>
			<td>Specify the date (mm-dd-yyyy).</td>
		</tr>
	</tbody>
</table>

<h2>Configuring the LookupCache policy</h2>
<p>Configure the LookupCache policy using the following elements.</p>
<table border="0" cellpadding="1" cellspacing="1" class="table" style="width: 690px;">
	<thead>
		<tr>
			<th colspan="2" style="text-align: left;">Field Name</th>
			<th style="text-align: left;">Description</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td colspan="2">CacheResource</td>
			<td>Specifies the cache resource to be used.</td>
		</tr>
		<tr>
			<td colspan="2">AssignTo</td>
			<td>Specifies the variable where the cache entry needs to be assigned. Note that the variable must have write permissions.</td>
		</tr>
		<tr>
			<td colspan="2">Scope</td>
			<td>Used to construct the prefix, when a Prefix is not provided in CacheKey. If a Prefix element is present in CacheKey, then Scope is ignored.<br>
			<ul><li>Global: Cache keys prepended with <code>envName__</code></li>
			<li>Application: Cache key prepended <code>envName__appName</code></li>
			<li>Proxy: Cache key prepended with <code>__proxyEndpointName</code></li>
			<li>Target: Cache key prepended with <code>__targetEndpointName</code></li>
			<li>Exclusive: Cache key prepended with <code>envName__apiProxyName</code></li></ul></td>
		</tr>
		<tr>
			<td colspan="1" rowspan="2">CacheKey</td>
			<td>Prefix</td>
			<td>
				<div>Used for matching future requests to the cached response.</div>
				<div>If provided, it is used as the prefix for all entries put into the cache by the policy.</div>
			</td>
		</tr>
		<tr>
			<td>KeyFragment</td>
			<td>
				<div>A cache key fragment can either contain a key or a value.</div>
				<div>All fragments together (plus the prefix) are concatenated to create the cache key. For example, if a request message has headers id1=1 &amp; id2=1 then the cache key is <em>Apigee__1__2</em>.</div>
			</td>
		</tr>
	</tbody>
</table>
<h4>Example: LookupCache policy</h4>
<p>[gist:2627295]</p>
<h4>Flow variables - Read from Cache policy</h4>
<p>Flow variables play a pivotal role in the message flow. These variables enable advanced users to customize the behavior of policies and flows, based on HTTP headers or message content, or the context available in the flow. For more information about flow variables, see [node:243].</p>
<p>The following predefined flow variables are available after you customize the behavior of the cache you define in a LookupCache policy.</p>
<table border="0" cellpadding="1" cellspacing="1" class="table" style="width: 690px;">
	<thead>
		<tr>
			<th scope="col">Variables</th>
			<th scope="col">Type</th>
			<th scope="col">Permission</th>
			<th scope="col">Description</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>lookupcache.&lt;policy-name&gt;.cachename</td>
			<td>String</td>
			<td>Read-Only</td>
			<td>Returns the cache name used in the policy.</td>
		</tr>
		<tr>
			<td>lookupcache.&lt;policy-name&gt;.cachekey</td>
			<td>String</td>
			<td>Read-Only</td>
			<td>Returns the key used.</td>
		</tr>
		<tr>
			<td>lookupcache.&lt;policy-name&gt;.cachehit</td>
			<td>Boolean</td>
			<td>Read-Only</td>
			<td>True if the policy execution is successful.</td>
		</tr>
		<tr>
			<td>lookupcache.&lt;policy-name&gt;.assignto</td>
			<td>String</td>
			<td>Read-Only</td>
			<td>Returns the variable to which cache is assigned.</td>
		</tr>
	</tbody>
</table>

<h2><a class="jumplink" name="invalidate"></a>Configuring the InvalidateCache policy</h2>

<p>Configure the InvalidateCache policy using the following elements.</p>
<table border="0" cellpadding="1" cellspacing="1" class="table" style="width: 690px;">
	<thead>
		<tr>
			<th colspan="2" style="text-align: left;">Field Name</th>
			<th style="text-align: left;">Description</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td colspan="2">CacheResource (<span style="color: rgb(169, 169, 169);">Mandatory</span>)</td>
			<td>Specifies the cache resource to be used.</td>
		</tr>
		<tr>
			<td colspan="2">Scope (<span style="color: rgb(169, 169, 169);">Optional</span>)</td>
			<td>Used to construct the prefix, when Prefix in CacheKey is not provided. If Prefix is provided, then Scope is ignored.<br>
				Allowed values are Global, Application, Proxy, Target, and Exclusive.</td>
		</tr>
		<tr>
			<td colspan="1" rowspan="3">CacheContext (<span style="color: rgb(169, 169, 169);">Optional</span>)</td>
			<td>Application</td>
			<td rowspan="3" style="vertical-align: middle;">Used to construct the cache key.</td>
		</tr>
		<tr>
			<td>Proxy</td>
		</tr>
		<tr>
			<td>Target</td>
		</tr>
		<tr>
			<td colspan="1" rowspan="2">CacheKey (<span style="color: rgb(169, 169, 169);">Optional</span>)</td>
			<td>Prefix</td>
			<td>
				<div>Used for matching future requests to the cached response.</div>
				<div>If provided, it is used as the prefix for all entries put into the cache by the policy.</div>
			</td>
		</tr>
		<tr>
			<td>KeyFragment</td>
			<td>
				<div>A cache key fragment can either contain a key or a value.</div>
				<div>All fragments (plus the prefix) are concatenated to create the cache key. For example, if a request message has headers id1=1 &amp; id2=1 then the cache key is <em>Apigee__1__2</em>.</div>
			</td>
		</tr>
		<tr>
			<td colspan="2">PurgeChildEntries (<span style="color: rgb(169, 169, 169);">Optional</span>)</td>
			<td>Valid values: true/false<br>
				Default value: false</td>
		</tr>
	</tbody>
</table>

<h2><a class="jumplink" name="schema"></a>Policy schema</h2>
<p>Each policy must conform to a policy schema. All policy constructs such as elements and attributes mentioned above are defined in a schema. To download the schema, <a href="/docs/download/file/fid/197">click here</a>.</p>
