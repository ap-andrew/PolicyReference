<p>[toc]</p>
<p>OAuth 2.0 defines a protocol for securing application access to protected resources, which are accessed through APIs. OAuth 2.0 relies on access tokens presented via apps on behalf of app end users when requesting RESTful resources via APIs. These tokens must be obtained before the app can access the protected resource. An access token contains a set of attributes and policies that relate to both the app and the app end user, and these attributes are used for making authorization decisions at run time.</p>

<p>For working examples of OAuth 2.0-enabled API proxies, please refer to the  <a href="https://github.com/apigee/api-platform-samples">API Platform samples</a> available on GitHub.</p>

Setting up OAuth 2.0 is a three step process:
<ol><li><b>Configure a token endpoint:</b> An OAuth token endpoint defines a URI on the API Platform. The token endpoint is configured with a policy of type <code>OAUthV2</code>. In the <code>OAUthV2</code> policy, the GenerateAccessToken operation is specified. When this operation is specified, you have the option of configuring one or more grant types. For each grant type specified, an additional set of configuration elements are exposed, providing flexibility in the way that APIs exposed through the API Platform manage OAuth-based authorization. </li>
<li><b>Apply an OAuth validation policy to protected resource URIs:</b> To enforce OAuth at runtime, attach a policy of type <code>OAUthV2</code> to a Flow that exposes a protected resource. In the <code>OAUthV2</code> policy, specify the <code>VerifyAccessToken</code> operation.</li>
<li><b>Configure one or more API products:</b> The <code>VerifyAccessToken</code> operation resolves the access token to an API product for which the app has been approved. The request URI is verified against the list of URIs defined in the API product. If the request URI is included in the list defined by the approved API product, then the request is forwarded to the protected resource.</li></ol>

<h2>Configuring token endpoints</h2>

<p>OAuth 2.0 policies are used both to <i>generate</i> and to <i>validate</i> OAuth 2.0-compliant tokens. To generate tokens on behalf of app end users, OAuth 2.0  policies that specify the <code>GenerateAccessToken</code> operation are attached to a token endpoint. It is recommended that you deploy a single API proxy to function as a token endpoint for all API proxies in an environment.</p>
	
<p>A token endpoint is simply a URI path that the system uses to identify requests for access tokens. Strictly speaking, a token endpoint is a conditional flow to which an OAuthV2 policy that specified the <code>GenerateAccessToken</code> operation as an element.</p>

<p>For example, to configure a token endpoint that generates tokens on requests to the URI path <code>/accesstoken</code>:</p>

<pre class="prettify">&lt;Flow name=&quot;TokenEndpoint&quot;&gt;
  &lt;Condition&gt;proxy.pathsuffix MatchesPath &quot;/accesstoken&quot;&lt;/Condition&gt;
  &lt;Request&gt;
    &lt;Step&gt;&lt;Name&gt;GenerateAccessToken&lt;/Name&gt;&lt;/Step&gt;
  &lt;/Request&gt;
&lt;/Flow&gt;
</pre>
<p>Note that the variable <code>proxy.pathsuffix</code> defines the URI fragment following the base path configured in the ProxyEndpoint. Thus, to obtain an OAuth token, an app makes a request to, for example:</p>

<pre>http://{org_name}-prod.apigee.net/oauth/accesstoken</pre>

<p>As the proxy path is <code>/oauth</code> and suffix is <code>/accesstoken</code>.</p>

<p>Similarly, you can configure authorization endpoints to issue authorization codes. For example:</p>

<pre>&lt;Flow name=&quot;AuthorizationEndpoint&quot;&gt;
  &lt;Condition&gt;proxy.pathsuffix == &quot;/authorize&quot;&lt;/Condition&gt;
  &lt;Request&gt;
    &lt;Step&gt;&lt;Name&gt;GenerateAuthCode&lt;/Name&gt;&lt;/Step&gt;
  &lt;/Request&gt;
&lt;/Flow&gt;</pre>

<p>OAuth 2.0 policies generate access tokens using the <code>GrantType</code> method element. Four grant types, specified by OAuth 2.0, are supported: </p>
	
<ul>
	<li>Client credentials: "Two-legged" OAuth, usually implemented for trusted clients (for example, apps developed by the API provider themselves).</li>
	<li>Authorization code" "Three-legged" OAuth", which enables an app end users to obtain an access token without exposing credentials to the app. The app requests an access token using an authorization code returned by the intermediary who authenticates the app end user. The API Platform can act as both authorization server (generating authorization codes) and as a token endpoint (issuing access tokens in return for valid authorization codes).</li>
	<li>Implicit: A variation on authorization code, usually implemented for browser-based apps implemented in scripting languages such as JavaScript</li>
    <li>Resource Owner Password Credentials: Used only when apps are trusted, enables a user to obtain an access token in return for provide valid username/password credentials. The benefit of password grant type is the one-time use of password credentials to obtain a long-lived access token.</li>
</ul>



<h2>Validating access tokens</h2>

<p>Once a token endpoint is set up for an API proxy, a corresponding OAuthV2 policy that specifies the <code>VerifyAccessToken</code> operation is attached to the Flow that exposes the protected resource. Requesting client apps must be configured to first generate a request to the token endpoint to obtain an access token. Once an access token has been obtained, the token is presented by the app, and the token is verified by the VerifyAccessToken policy.</p>

For example, to ensure that all requests to an API are verified, the following policy enforces access token verification:

<pre>&lt;OAuthV2 name=&quot;VerifyOAuthAccessToken&quot;&gt;
  &lt;Operation&gt;VerifyAccessToken&lt;/Operation&gt;
&lt;/OAuthV2&gt;</pre>

<p>The policy is then attached to the API resources to be protected. To ensure that all requests to an API are verified, attach the policy to the ProxyEndpoint request PreFlow, as follows:</p>

<pre>&lt;ProxyEndpoint name=&quot;default&quot;&gt;
&lt;PreFlow&gt;
    &lt;Request&gt;
	&lt;Step&gt;&lt;Name&gt;VerifyOAuthAccessToken&lt;/Name&gt;&lt;/Step&gt;
    &lt;/Request&gt;
&lt;/PreFlow&gt;
&lt;!-- Remainder of ProxyEndpoint configuration --&gt;</pre>

<h2>OAuth and API products</h2>

<p>OAuth is the mechanism used by the API Platform to enforce authorization based on API product settings. When an app presents an access token, the API Platform resolves the access token to the API product for which  the app has been approved. Every API product defines a set of URIs, that is, a bundle of protected API resources accessible only by approved apps.</p>

<p>API products can be configured in the Management UI or by using the Platform API.</p>

<p>For instructions on creating API products using the UI, see: [node:9]</p>
<p>For instructions on creating API products using the API, see: [node:427]
</p>
<h2>Delegating token management</h2>

<p>Remote token stores can be used against the API Platform. If a remote token store is used, the following element should be configured in GenerateAccessToken policy.</p>

<code>&lt;StoreToken&gt;false&lt;/StoreToken&gt;</code>

<p>If token validation has been delegated to a remote token service, then the following element must be configured, identifying the location of the token in the request message. By specifying an <code>ExternalAccessToken</code> element, you indicate that the API Platform should not attempt to validate the token.</p>

<pre>&lt;ExternalAccessToken&gt; request.header.external_access_token | request.formparam.external_access_token | request.queryparam.external_access_token &lt;/ExternalAccessToken&gt;</pre>

<p>Note that if you configure support for an external access token service, you must implement a ServiceCallout that enforces the token check. Such as ServiceCallout is beyond the scope of this document, so contact <a href="mailto:support@apigee.com">support@apigee.com</a> for more information on implementing integrations with remote token services.</p>

<h2><a class="jumplink" name="details"></a>Grant type policy details</h2>The OAuth 2.0 policy enables the user to specify which API calls to secure with OAuth 2.0. The OAuth policy exposes configuration variables that enable the user to configure the behavior of the policy. Apigee supports the following OAuth policies based on the OAuth 2.0 specification.</p>
<table border="1" cellpadding="1" cellspacing="1" class="table" style="width: 700px; ">
	<thead>
		<tr>
			<th>Grant Type</th>
			<th style="width: 75px; ">Policy Format</th>
			<th style="width: 100px; ">Description</th>
			<th>Configuration Example</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td rowspan="3">authorization_code</td>
			<td>Generate Authorization Code</td>
			<td>Generates an access token and refreshes the token. Attach the policy at the authorization end point.</td>
			<td>
				<pre>&lt;OAuthV2 name="GetAuthCode"&gt;
&lt;Operation&gt;GenerateAuthorizationCode
&lt;/Operation&gt;
&lt;ExpiresIn&gt;1000&lt;/ExpiresIn&gt;
&lt;GenerateResponse /&gt;
&lt;/OAuthV2&gt;</pre>
			</td>
		</tr>
		<tr>
			<td>Generate AccessToken</td>
			<td>Token used to gain access to the protected resources (target APIs). Attach the policy at the access token end point.</td>
			<td>
				<pre>&lt;OAuthV2 name="GenerateAccessToken"&gt;
&lt;Operation&gt;GenerateAccessToken
&lt;/Operation&gt;
&lt;ExpiresIn&gt;1000&lt;/ExpiresIn&gt;
&lt;GenerateResponse /&gt;
&lt;SupportedGrantTypes&gt;
	&lt;GrantType&gt;authorization_code&lt;/GrantType&gt;
&lt;/SupportedGrantTypes&gt;
&lt;GrantType&gt;request.queryparam.grant_type&lt;/GrantType&gt;
&lt;Code&gt;request.queryparam.code&lt;/Code&gt;
&lt;ClientId&gt;request.queryparam.client_id&lt;/ClientId&gt;
&lt;RedirectUri&gt;request.queryparam.redirect_uri&lt;/RedirectUri&gt;
&lt;Scope&gt;request.queryparam.scope&lt;/Scope&gt;
&lt;/OAuthV2&gt;</pre>
			</td>
		</tr>
		<tr>
			<td>Refresh AccessToken</td>
			<td>Token used to re-issue the access token post expiry. Attach the policy at the refresh token end point.</td>
			<td>
				<pre>&lt;OAuthV2 name="RefreshAccessToken"&gt;
&lt;Operation&gt;RefreshAccessToken
&lt;/Operation&gt;
&lt;ExpiresIn&gt;1000&lt;/ExpiresIn&gt;
&lt;GenerateResponse /&gt;
&lt;/OAuthV2&gt;</pre>
			</td>
		</tr>
		<tr>
			<td>implicit</td>
			<td>GenerateImplicit AccessToken</td>
			<td>Attach the policy at the access token endpoint.</td>
			<td>
				<pre>&lt;OAuthV2 name="GenerateAccessTokenImplicit"&gt;
&lt;Operation&gt;GenerateAccessTokenImplicitGrant
&lt;/Operation&gt;
&lt;ExpiresIn&gt;1000&lt;/ExpiresIn&gt;
&nbsp;&lt;GenerateResponse /&gt;

&lt;ResponseType&gt;request.queryparam.response_type&lt;/ResponseType&gt; 
&lt;ClientId&gt;request.queryparam.client_id&lt;/ClientId&gt; 
&lt;RedirectUri&gt;request.queryparam.redirect_uri&lt;/RedirectUri&gt;  
&lt;Scope&gt;request.queryparam.scope&lt;/Scope&gt;  
&lt;State&gt;request.queryparam.state&lt;/State&gt; 
&lt;AppEndUser&gt;request.queryparam.app_enduser&lt;/AppEndUser&gt; 
&lt;/OAuthV2&gt;</pre>
			</td>
		</tr>
		<tr>
			<td rowspan="2">password</td>
			<td>Generate AccessToken</td>
			<td>Attach the policy at the access token end point.</td>
			<td>
				<pre>&lt;OAuthV2 name="GenerateAccessToken"&gt;
&lt;Operation&gt;GenerateAccessToken
&lt;/Operation&gt;
&lt;ExpiresIn&gt;1000&lt;/ExpiresIn&gt;
&lt;GenerateResponse /&gt;
&lt;SupportedGrantTypes&gt;
    &lt;GrantType&gt;password&lt;/GrantType&gt;
&lt;/SupportedGrantTypes&gt;
&lt;GrantType&gt;request.queryparam.grant_type&lt;/GrantType&gt; 
&lt;ClientId&gt;request.queryparam.client_id&lt;/ClientId&gt;    
&lt;Scope&gt;request.queryparam.scope&lt;/Scope&gt;
&lt;AppEndUser&gt;request.queryparam.app_enduser&lt;/AppEndUser&gt;  
&lt;UserName&gt;request.queryparam.user_name&lt;/UserName&gt;
&lt;PassWord&gt;request.queryparam.password&lt;/PassWord&gt; 
&lt;/OAuthV2&gt;</pre>
			</td>
		</tr>
		<tr>
			<td>Refresh AccessToken</td>
			<td>Attach the policy at the refresh token end point.</td>
			<td>
				<pre>&lt;OAuthV2 name="RefreshAccessToken"&gt;
&lt;Operation&gt;RefreshAccessToken
&lt;/Operation&gt;
&lt;ExpiresIn&gt;1000&lt;/ExpiresIn&gt;
&lt;GenerateResponse /&gt;
&lt;/OAuthV2&gt;</pre>
			</td>
		</tr>
		<tr>
			<td>client_credentials</td>
			<td>Generate AccessToken</td>
			<td>Attach the policy at the access token end point.</td>
			<td>
				<pre>&lt;OAuthV2 name="GenerateAccessToken"&gt;
&lt;Operation&gt;GenerateAccessToken
&lt;/Operation&gt;
&lt;ExpiresIn&gt;1000&lt;/ExpiresIn&gt;
&lt;GenerateResponse /&gt;
&lt;SupportedGrantTypes&gt;
  &lt;GrantType&gt;client_credentials&lt;/GrantType&gt;
&lt;/SupportedGrantTypes&gt;
&lt;GrantType&gt;request.queryparam.grant_type&lt;/GrantType&gt;
&lt;/OAuthV2&gt;</pre>
			</td>
		</tr>
		<tr>
			<td colspan="4">
				<p><strong>Note:</strong> <em>ExpiresIn</em> (optional) enforces the expiry time of the authorization code in milliseconds. The expiry time of authorization code is system generated plus ExpiresIn value. If ExpiresIn is -1, the system considers it as a infinite life time. If it is not specified, the system applies a default value configured at system level.</p>
			</td>
		</tr>
	</tbody>
</table>
<h2><a class="jumplink" name="token_policy"></a>VerifyAccessToken policy</h2>
<p>The API Platform validates access tokens at runtime. If the validation evaluates to true, the app end user is given access to the protected resource.</p>
<pre>&lt;OAuthV2 name="VerifyAccessToken"&gt;
&nbsp;&nbsp;&nbsp; &lt;Operation&gt;VerifyAccessToken&lt;/Operation&gt;
&nbsp;&nbsp;&nbsp; &lt;Scope&gt;READ WRITE&lt;/Scope&gt;
&lt;/OAuthV2&gt;</pre>
<p><strong>Note:</strong> Only bearer tokens are currently supported. MAC tokens are not supported. The access token must be passed in the authorization header. For example, a sample authorization header is <span style="font-family:courier new,courier,monospace;">"Authorization: Bearer {Base64_Of_AccessToken}"</span>.</p>
<p>For information on flow variables populated during the policy execution, refer to [node:241].</p>
<h2><a class="jumplink" name="schema"></a>Policy schema</h2>
<p>Each policy must conform to a policy schema. All policy constructs such as elements and attributes mentioned above are defined in a schema. To download the schema, <a href="/docs/download/file/fid/193">click here</a>.</p>
